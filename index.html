<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kill Team Companion</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body {
      background: #141414;
      color: #F0EDE8;
      font-family: 'Barlow', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }
    ::selection { background: #E8500A; color: #000; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #141414; }
    ::-webkit-scrollbar-thumb { background: #7a2a05; border-radius: 2px; }
    textarea, input { outline: none; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fade-up { animation: fadeUp 0.25s ease forwards; }
    .spinner {
      width: 18px; height: 18px;
      border: 2px solid #7a2a05;
      border-top-color: #E8500A;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: inline-block;
      flex-shrink: 0;
    }
    .watermark {
      position: fixed; top: 0; right: 0;
      width: 200px; height: 200px;
      opacity: 0.04; pointer-events: none; z-index: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const C = {
      bg:        '#141414',
      card:      '#1e1e1e',
      input:     '#252525',
      orange:    '#E8500A',
      orangeDim: '#7a2a05',
      white:     '#F0EDE8',
      gray:      '#888880',
      grayDim:   '#444440',
      border:    '#2e2e2e',
    };
    const FD = "'Barlow Condensed', Impact, sans-serif";
    const FB = "'Barlow', 'Helvetica Neue', sans-serif";

    // ── ICONS ──────────────────────────────────────────────────────────────
    const IcoSearch = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
    const IcoBook   = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
    const IcoGear   = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
    const IcoSend   = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
    const IcoX      = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
    const IcoChev   = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>;

    // ── DATA ───────────────────────────────────────────────────────────────
    const SECTIONS = [
      { id:'core', title:'CORE RULES', subs:[
        { id:'core-overview',   label:'Overview & Setup',     url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-sequence',   label:'Battle Sequence',       url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-activation', label:'Activation & Actions',  url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-movement',   label:'Movement',              url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-shooting',   label:'Shooting',              url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-fighting',   label:'Fighting (Melee)',      url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-morale',     label:'Resolve & Morale',      url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-conditions', label:'Conditions',            url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-terrain',    label:'Terrain & Cover',       url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
        { id:'core-vps',        label:'Victory Points',        url:'https://wahapedia.ru/kill-team3/the-rules/core-rules/' },
      ]},
      { id:'ops', title:'PLOYS', subs:[
        { id:'ops-strategic', label:'Strategic Ploys', url:'https://wahapedia.ru/kill-team3/the-rules/strategic-and-tactical-ploys/' },
        { id:'ops-tactical',  label:'Tactical Ploys',  url:'https://wahapedia.ru/kill-team3/the-rules/strategic-and-tactical-ploys/' },
      ]},
      { id:'equip', title:'UNIVERSAL EQUIPMENT', subs:[
        { id:'equip-list', label:'Equipment List', url:'https://wahapedia.ru/kill-team3/the-rules/universal-equipment/' },
      ]},
      { id:'kz', title:'KILL ZONES', subs:[
        { id:'kz-rules', label:'Kill Zone Rules', url:'https://wahapedia.ru/kill-team3/the-rules/killzones/' },
        { id:'kz-list',  label:'Kill Zone List',  url:'https://wahapedia.ru/kill-team3/the-rules/killzones/' },
      ]},
      { id:'app', title:'APPENDIX', subs:[
        { id:'app-kw',  label:'Keywords Glossary',      url:'https://wahapedia.ru/kill-team3/the-rules/appendix/' },
        { id:'app-faq', label:"Designer's Notes & FAQ", url:'https://wahapedia.ru/kill-team3/the-rules/appendix/' },
      ]},
    ];

    const SUGGESTED = [
      "How does the Conceal order work?",
      "Can I shoot after moving?",
      "What happens when an operative is incapacitated?",
      "How does cover work against shooting?",
      "What is the activation sequence each turning point?",
      "How do critical hits work in melee?",
    ];

    // ── TOP BAR ────────────────────────────────────────────────────────────
    function TopBar() {
      return (
        <header style={{
          position:'fixed', top:0, left:0, right:0, zIndex:100,
          background:C.bg, borderBottom:`1px solid ${C.border}`,
          padding:'11px 16px', display:'flex',
          alignItems:'center', justifyContent:'space-between',
        }}>
          <div style={{ display:'flex', alignItems:'center', gap:10 }}>
            <svg width="22" height="22" viewBox="0 0 24 24">
              <polygon points="12,2 22,20 2,20" fill={C.orange}/>
              <polygon points="12,8 18,20 6,20" fill={C.bg}/>
            </svg>
            <span style={{ fontFamily:FD, fontWeight:800, fontSize:18, letterSpacing:'0.08em' }}>
              KILL TEAM <span style={{ color:C.orange }}>COMPANION</span>
            </span>
          </div>
          <a href="https://wahapedia.ru/kill-team3/the-rules/core-rules/"
            target="_blank" rel="noopener noreferrer"
            style={{
              fontSize:11, fontFamily:FD, fontWeight:600, letterSpacing:'0.05em',
              color:C.orange, background:`${C.orange}15`,
              border:`1px solid ${C.orangeDim}`,
              padding:'3px 8px', borderRadius:3, textDecoration:'none',
            }}>
            WAHAPEDIA ↗
          </a>
        </header>
      );
    }

    // ── BOTTOM NAV ─────────────────────────────────────────────────────────
    function Nav({ tab, setTab }) {
      const items = [
        { id:'qa',       label:'Q&A',      icon:<IcoSearch /> },
        { id:'rules',    label:'RULES',    icon:<IcoBook /> },
        { id:'settings', label:'SETTINGS', icon:<IcoGear /> },
      ];
      return (
        <nav style={{
          position:'fixed', bottom:0, left:0, right:0, zIndex:100,
          background:C.card, borderTop:`1px solid ${C.border}`, display:'flex',
        }}>
          {items.map(i => (
            <button key={i.id} onClick={() => setTab(i.id)} style={{
              flex:1, background:'none', border:'none',
              borderTop: tab===i.id ? `2px solid ${C.orange}` : '2px solid transparent',
              color: tab===i.id ? C.orange : C.gray,
              padding:'11px 0 9px', cursor:'pointer',
              display:'flex', flexDirection:'column', alignItems:'center', gap:4,
              fontFamily:FD, fontSize:11, fontWeight:700, letterSpacing:'0.1em',
              transition:'color 0.15s',
            }}>
              {i.icon}{i.label}
            </button>
          ))}
        </nav>
      );
    }

    // ── ANSWER CARD ────────────────────────────────────────────────────────
    function AnswerCard({ item, onRemove }) {
      return (
        <div className="fade-up" style={{
          background:C.card, border:`1px solid ${C.border}`,
          borderLeft:`3px solid ${C.orange}`,
          borderRadius:6, padding:'14px 16px', marginBottom:12,
        }}>
          <div style={{
            display:'flex', justifyContent:'space-between',
            alignItems:'flex-start', gap:8, marginBottom:10,
          }}>
            <span style={{
              fontFamily:FD, fontWeight:700, fontSize:13,
              letterSpacing:'0.05em', color:C.orange, lineHeight:1.4,
            }}>
              {item.question}
            </span>
            <button onClick={onRemove} style={{
              background:'none', border:'none', color:C.grayDim,
              cursor:'pointer', padding:2, flexShrink:0,
            }}>
              <IcoX />
            </button>
          </div>
          {item.usedFallback && (
            <div style={{
              display:'flex', alignItems:'center', gap:6,
              background:'#2a1f00', border:'1px solid #6a4f00',
              borderRadius:4, padding:'6px 10px', marginBottom:10,
              fontSize:11, color:'#ffaa00',
              fontFamily:FD, fontWeight:700, letterSpacing:'0.05em',
            }}>
              ⚠ UNVERIFIED — answered from training knowledge. Confirm on Wahapedia.
            </div>
          )}
          <div style={{ fontSize:14, lineHeight:1.7, color:C.white, whiteSpace:'pre-wrap' }}>
            {item.answer}
          </div>
          <div style={{ marginTop:10 }}>
            <a href="https://wahapedia.ru/kill-team3/the-rules/core-rules/"
              target="_blank" rel="noopener noreferrer"
              style={{
                fontSize:10, fontFamily:FD, fontWeight:600,
                letterSpacing:'0.05em', color:C.orange,
                background:`${C.orange}10`, border:`1px solid ${C.orangeDim}`,
                padding:'2px 8px', borderRadius:3, textDecoration:'none',
              }}>
              ↗ Wahapedia Kill Team 3rd Ed.
            </a>
          </div>
        </div>
      );
    }

    // ── Q&A TAB ────────────────────────────────────────────────────────────
    function QATab({ apiKey }) {
      const [q, setQ]       = useState('');
      const [loading, setL] = useState(false);
      const [history, setH] = useState([]);
      const [error, setE]   = useState(null);
      const taRef           = useRef(null);

      useEffect(() => { taRef.current?.focus(); }, []);

      const resize = e => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 160) + 'px';
      };

      const ask = async () => {
        if (!q.trim() || loading) return;

        const question = q.trim();
        setL(true); setE(null); setQ('');
        if (taRef.current) taRef.current.style.height = 'auto';

        try {
          // Call our Netlify function instead of Anthropic directly
          const res = await fetch('/.netlify/functions/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question }),
          });

          // Read as text first so we never crash on empty/non-JSON responses
          const rawText = await res.text();

          if (!rawText || rawText.trim() === '') {
            throw new Error(`Empty response from server (status ${res.status}). The function may not be deployed — check Netlify Functions tab.`);
          }

          let data;
          try {
            data = JSON.parse(rawText);
          } catch(e) {
            throw new Error(`Server returned non-JSON (status ${res.status}): ${rawText.slice(0, 300)}`);
          }

          if (!res.ok) {
            throw new Error(data.error || `API error ${res.status}`);
          }

          setH(prev => [{ question, answer: data.answer, usedFallback: data.usedFallback || false }, ...prev]);
        } catch (err) {
          setE(err.message);
        } finally {
          setL(false);
        }
      };

      const onKey = e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); }
      };

      return (
        <div style={{ padding:'16px 16px 0' }}>
          <div style={{
            background:C.input, border:`1px solid ${C.border}`,
            borderRadius:8, padding:'12px 14px', marginBottom:14,
          }}>
            <textarea
              ref={taRef}
              value={q}
              onChange={e => { setQ(e.target.value); resize(e); }}
              onKeyDown={onKey}
              placeholder="Ask a rules question… (Enter to send, Shift+Enter for new line)"
              rows={2}
              style={{
                width:'100%', background:'none', border:'none',
                color:C.white, fontFamily:FB, fontSize:15,
                lineHeight:1.55, resize:'none',
              }}
            />
            <div style={{ display:'flex', justifyContent:'flex-end', marginTop:8 }}>
              <button onClick={ask} disabled={!q.trim() || loading} style={{
                background: q.trim() && !loading ? C.orange : C.grayDim,
                border:'none', color:'#fff', borderRadius:5,
                padding:'8px 16px', cursor: q.trim() && !loading ? 'pointer' : 'not-allowed',
                display:'flex', alignItems:'center', gap:6,
                fontFamily:FD, fontWeight:700, fontSize:13,
                letterSpacing:'0.08em', transition:'background 0.15s',
              }}>
                {loading ? <span className="spinner"/> : <><IcoSend/> ASK</>}
              </button>
            </div>
          </div>

          {error && (
            <div style={{
              background:'#2a0a0a', border:'1px solid #5a1a1a',
              borderRadius:6, padding:'10px 14px', marginBottom:12,
              fontSize:13, color:'#ff7070',
            }}>
              ⚠ {error}
            </div>
          )}

          {loading && (
            <div className="fade-up" style={{
              background:C.card, border:`1px solid ${C.border}`,
              borderLeft:`3px solid ${C.orange}`,
              borderRadius:6, padding:'14px 16px', marginBottom:12,
              display:'flex', alignItems:'center', gap:10,
              color:C.gray, fontSize:13,
            }}>
              <span className="spinner"/> Searching rules…
            </div>
          )}

          {history.map((item, i) => (
            <AnswerCard key={i} item={item}
              onRemove={() => setH(prev => prev.filter((_,j) => j !== i))} />
          ))}

          {history.length === 0 && !loading && (
            <div>
              <div style={{
                fontSize:11, fontFamily:FD, fontWeight:700,
                letterSpacing:'0.12em', color:C.grayDim, marginBottom:10,
              }}>
                QUICK QUESTIONS
              </div>
              {SUGGESTED.map((s,i) => (
                <button key={i} onClick={() => setQ(s)} style={{
                  width:'100%', background:C.card,
                  border:`1px solid ${C.border}`, borderRadius:5,
                  padding:'10px 12px', color:C.white,
                  fontFamily:FB, fontSize:13, textAlign:'left',
                  cursor:'pointer', display:'flex',
                  justifyContent:'space-between', alignItems:'center',
                  marginBottom:6, transition:'border-color 0.15s',
                }}
                  onMouseEnter={e => e.currentTarget.style.borderColor = C.orangeDim}
                  onMouseLeave={e => e.currentTarget.style.borderColor = C.border}
                >
                  {s} <span style={{ color:C.orange }}><IcoChev/></span>
                </button>
              ))}
            </div>
          )}
        </div>
      );
    }

    // ── RULES TAB ──────────────────────────────────────────────────────────
    function RulesTab() {
      const [open, setOpen]     = useState(null);
      const [search, setSearch] = useState('');

      const filtered = SECTIONS
        .map(s => ({
          ...s,
          subs: s.subs.filter(sub =>
            !search || sub.label.toLowerCase().includes(search.toLowerCase())
          ),
        }))
        .filter(s => !search || s.subs.length > 0);

      return (
        <div style={{ padding:'16px' }}>
          <div style={{
            background:C.input, border:`1px solid ${C.border}`,
            borderRadius:6, padding:'9px 12px',
            display:'flex', alignItems:'center', gap:8, marginBottom:14,
          }}>
            <span style={{ color:C.gray }}><IcoSearch/></span>
            <input type="text" placeholder="Search sections…"
              value={search} onChange={e => setSearch(e.target.value)}
              style={{ flex:1, background:'none', border:'none', color:C.white, fontFamily:FB, fontSize:14 }}
            />
          </div>

          {filtered.map(s => (
            <div key={s.id} style={{ marginBottom:8 }}>
              <button onClick={() => setOpen(open===s.id ? null : s.id)} style={{
                width:'100%',
                background: open===s.id ? `${C.orange}18` : C.card,
                border:`1px solid ${open===s.id ? C.orangeDim : C.border}`,
                borderRadius: open===s.id ? '6px 6px 0 0' : 6,
                padding:'12px 14px', color: open===s.id ? C.orange : C.white,
                fontFamily:FD, fontWeight:700, fontSize:14,
                letterSpacing:'0.08em', textAlign:'left', cursor:'pointer',
                display:'flex', justifyContent:'space-between', alignItems:'center',
                transition:'all 0.15s',
              }}>
                {s.title}
                <span style={{ transform:open===s.id?'rotate(90deg)':'none', transition:'transform 0.2s', color:C.orange }}>
                  <IcoChev/>
                </span>
              </button>
              {open===s.id && (
                <div className="fade-up" style={{
                  background:C.card, border:`1px solid ${C.border}`,
                  borderTop:'none', borderRadius:'0 0 6px 6px', overflow:'hidden',
                }}>
                  {s.subs.map((sub,i) => (
                    <a key={sub.id} href={sub.url} target="_blank" rel="noopener noreferrer"
                      style={{
                        display:'flex', justifyContent:'space-between', alignItems:'center',
                        padding:'11px 16px',
                        borderTop: i>0 ? `1px solid ${C.border}` : 'none',
                        color:C.white, textDecoration:'none', fontFamily:FB, fontSize:14,
                        transition:'background 0.1s',
                      }}
                      onMouseEnter={e => e.currentTarget.style.background='#252520'}
                      onMouseLeave={e => e.currentTarget.style.background='transparent'}
                    >
                      {sub.label}
                      <span style={{ color:C.orange, fontSize:11, flexShrink:0 }}>↗ Wahapedia</span>
                    </a>
                  ))}
                </div>
              )}
            </div>
          ))}

          <div style={{
            marginTop:14, padding:'11px 14px',
            background:'#1a1200', border:'1px solid #3a2800',
            borderRadius:6, fontSize:12, color:'#aa8830', lineHeight:1.55,
          }}>
            Rule sections open directly on Wahapedia — always current with the latest errata.
          </div>
        </div>
      );
    }

    // ── SETTINGS TAB ──────────────────────────────────────────────────────
    function SettingsTab({ apiKey, saveKey }) {
      const [val, setVal]     = useState(apiKey || '');
      const [saved, setSaved] = useState(false);

      const save = () => {
        saveKey(val.trim());
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
      };

      return (
        <div style={{ padding:'16px' }}>
          <div style={{
            background:C.card, border:`1px solid ${C.border}`,
            borderRadius:8, padding:'16px', marginBottom:12,
          }}>
            <div style={{ fontFamily:FD, fontWeight:700, fontSize:13, letterSpacing:'0.1em', color:C.orange, marginBottom:8 }}>
              ANTHROPIC API KEY
            </div>
            <p style={{ fontSize:13, color:C.gray, lineHeight:1.55, marginBottom:12 }}>
              Required for Q&A. Get your key at{' '}
              <a href="https://console.anthropic.com" target="_blank" rel="noopener noreferrer" style={{ color:C.orange }}>
                console.anthropic.com
              </a>.
              Stored in your browser only.
            </p>
            <input
              type="password" placeholder="sk-ant-api03-…"
              value={val} onChange={e => setVal(e.target.value)}
              onKeyDown={e => e.key==='Enter' && save()}
              style={{
                width:'100%', background:C.input,
                border:`1px solid ${C.border}`, borderRadius:6,
                padding:'10px 12px', color:C.white,
                fontFamily:'monospace', fontSize:13, marginBottom:10,
              }}
            />
            <button onClick={save} style={{
              background: saved ? '#1a4a1a' : C.orange,
              border:'none', color:'#fff', borderRadius:5,
              padding:'9px 20px', cursor:'pointer',
              fontFamily:FD, fontWeight:700, fontSize:13,
              letterSpacing:'0.08em', transition:'background 0.2s',
            }}>
              {saved ? '✓ SAVED' : 'SAVE KEY'}
            </button>
          </div>

          <div style={{
            background:C.card, border:`1px solid ${C.border}`,
            borderRadius:8, padding:'16px', marginBottom:12,
          }}>
            <div style={{ fontFamily:FD, fontWeight:700, fontSize:13, letterSpacing:'0.1em', color:C.orange, marginBottom:8 }}>
              TIPS FOR BEST RESULTS
            </div>
            {[
              'Ask specific questions — "Can I Overwatch after taking a Conceal order?" works better than "how does shooting work?"',
              'Include context if relevant — mention terrain type, phase, or operative state',
              'For complex interactions, ask one question at a time',
            ].map((tip,i) => (
              <div key={i} style={{ display:'flex', gap:8, marginBottom:i<2?8:0 }}>
                <span style={{ color:C.orange, flexShrink:0, fontFamily:FD, fontWeight:700 }}>—</span>
                <span style={{ fontSize:13, color:C.gray, lineHeight:1.55 }}>{tip}</span>
              </div>
            ))}
          </div>

          <div style={{
            background:C.card, border:`1px solid ${C.border}`,
            borderRadius:8, padding:'16px',
          }}>
            <div style={{ fontFamily:FD, fontWeight:700, fontSize:13, letterSpacing:'0.1em', color:C.orange, marginBottom:8 }}>
              ABOUT
            </div>
            <p style={{ fontSize:12, color:C.grayDim, lineHeight:1.7 }}>
              Kill Team Companion v0.1<br/>
              Rules sourced from Wahapedia.ru<br/>
              Not affiliated with Games Workshop.<br/>
              For personal, non-commercial use only.
            </p>
          </div>
        </div>
      );
    }

    // ── ROOT ───────────────────────────────────────────────────────────────
    function App() {
      const [tab, setTab] = useState('qa');
      const [apiKey, setApiKey] = useState(() => {
        try { return localStorage.getItem('kt_key') || ''; } catch { return ''; }
      });

      const saveKey = key => {
        setApiKey(key);
        try { localStorage.setItem('kt_key', key); } catch {}
      };

      return (
        <>
          <svg className="watermark" viewBox="0 0 200 200">
            <polygon points="100,10 190,190 10,190" fill="#E8500A"/>
            <polygon points="100,50 160,190 40,190" fill="#141414"/>
          </svg>
          <TopBar />
          <main style={{
            paddingTop:60, paddingBottom:80, minHeight:'100vh',
            position:'relative', zIndex:1, maxWidth:640, margin:'0 auto',
          }}>
            {tab==='qa'       && <QATab apiKey={apiKey} />}
            {tab==='rules'    && <RulesTab />}
            {tab==='settings' && <SettingsTab apiKey={apiKey} saveKey={saveKey} />}
          </main>
          <Nav tab={tab} setTab={setTab} />
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
